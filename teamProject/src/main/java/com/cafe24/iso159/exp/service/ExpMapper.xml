<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe24.iso159.exp.service.ExpMapper">

	<resultMap type="com.cafe24.iso159.exp.service.Exp" id="ExpVo">
		<id column="exp_code" property="expCode"/>
		<result column="animal_code" property="animalCode"/>
		<result column="m_exp_id" property="mExpId"/>
		<result column="m_shelter_id" property="mShelterId"/>
		<result column="bl_code" property="blCode"/>
		<result column="exp_period_code" property="expPeriodCode"/>
		<result column="os_code_exp" property="osCodeExp"/>
		<result column="os_code_cost_return" property="osCodeCostReturn"/>
		<result column="exp_journal_count" property="expJournalCount"/>
		<result column="exp_cost" property="expCost"/>
		<result column="exp_purpose" property="expPurpose"/>
		<result column="exp_reserve_request_date" property="expReserveRequestDate"/>
		<result column="exp_check_date" property="expCheckDate"/>
		<result column="exp_start_date" property="expStartDate"/>
		<result column="exp_end_date" property="expEndDate"/>
	</resultMap>
		
	<resultMap type="com.cafe24.iso159.animal.service.Animal" id="AnimalVo">
		<id column="animal_code" property="animalCode"/>
		<result column="os_code_animal" property="osCodeAnimal"/>
		<result column="bl_code" property="blCode"/>
		<result column="m_shelter_id" property="mShelterId"/>
		<result column="os_code_kind" property="osCodeKind"/>
		<result column="animal_breed" property="animalBreed"/>
		<result column="animal_area" property="animalArea"/>
		<result column="animal_id_code" property="animalIdCode"/>
		<result column="animal_weight" property="animalWeight"/>
		<result column="animal_age" property="animalAge"/>
		<result column="animal_enroll_date" property="animalEnrollDate"/>
	</resultMap>
	
	<resultMap type="com.cafe24.iso159.shelter.service.BusinessLicense" id="BusinessLicenseVo">
		<id column="bl_code" property="blCode"/>
		<result column="m_member_id" property="mMemberId"/>
		<result column="os_code_license_status" property="osCodeLicenseStatus"/>
		<result column="bl_shelter_name" property="blShelterName"/>
		<result column="bl_shelter_number" property="blShelterNumber"/>
		<result column="bl_shelter_postcode" property="blShelterPostcode"/>
		<result column="bl_shelter_address" property="blShelterAddress"/>
		<result column="bl_shelter_deny_reason" property="blShelterDenyReason"/>
		<result column="bl_shelter_date" property="blShelterDate"/>
	</resultMap>
	
	<resultMap type="com.cafe24.iso159.service.common.OverallStatus" id="OverallStatusVo">
		<id column="os_code" property="osCode"/>
		<result column="os_large" property="osLarge"/>
		<result column="os_large_level" property="osLargeLevel"/>
		<result column="os_small" property="osSmall"/>
		<result column="os_small_level" property="osSmallLevel"/>
		<result column="os_name" property="osName"/>
		<result column="os_name_level" property="osNameLevel"/>
	</resultMap>
	
	<!-- 체험 수정 -->
	<update id="updateExpOen" parameterType="com.cafe24.iso159.exp.service.Exp">
		UPDATE 
			t_exp 
		SET 
			exp_period_code=#{expPeriodCode}, 
		    exp_journal_count=#{expJournalCount}, 
		    exp_cost=#{expCost}, 
		    exp_purpose=#{expPurpose}, 
		    exp_modified_date=now(), 
		    exp_start_date=#{expStartDate}, 
		    exp_end_date=#{expEndDate}
		WHERE 
			exp_code=#{expCode}
	</update>
	
	<!-- 체험 수정 정보 띄움 -->
	<select id="selectUpdateExpOne" parameterType="com.cafe24.iso159.exp.service.Exp">
		SELECT
			exp_purpose AS expPurpost, 
		    exp_start_date AS expStartDate, 
		    exp_end_date AS expEndDate
		FROM 
			t_exp
		WHERE
			exp_code = #{expCode}
	</select>
	
	<!-- 체험 상세 정보 -->
	<resultMap type="com.cafe24.iso159.exp.service.ExpAndAnimalAndBusinessLicense" id="selectExpAndAnimalAndBusinessLicenseOneInfoMap">
		<id column="os_name" property="osName"/>
		<collection property="exp" resultMap="ExpVo"></collection>
		<collection property="animal" resultMap="AnimalVo"></collection>
		<collection property="businessLicense" resultMap="BusinessLicenseVo"></collection>
	</resultMap>
	<select id="selectExpAndAnimalAndBusinessLicenseOneInfo" resultMap="selectExpAndAnimalAndBusinessLicenseOneInfoMap" parameterType="String">
		SELECT 
			a.animal_breed
			,a.animal_weight
			,a.animal_age 
			,e.exp_code
			,e.m_shelter_id
			,e.exp_journal_count
			,e.exp_cost
			,e.exp_purpose
			,e.exp_reserve_request_date
			,e.exp_start_date
			,e.exp_end_date
			,os.os_name
			,bl.bl_shelter_name
			,bl.bl_shelter_address 
		FROM 
			t_exp e 
		INNER JOIN 
			t_animal a 
		ON 
			e.animal_code = a.animal_code 
		INNER JOIN 
			t_business_license bl 
		ON 
			e.bl_code = bl.bl_code 
		INNER JOIN
			t_overall_status os
		ON
			e.os_code_exp = os.os_code
		WHERE 
			e.exp_code = #{expCode}
	</select>
	
	<!-- 체험 신청 후 해당 사용자 신청한 목록 보는 부분 -->
	<resultMap type="com.cafe24.iso159.exp.service.ExpAndAnimal" id="selectExpOneListMap">
		<collection property="overallStatus" resultMap="OverallStatusVo"></collection>
		<collection property="exp" resultMap="ExpVo"></collection>
		<collection property="animal" resultMap="AnimalVo"></collection>
	</resultMap>
	<select id="selectExpOneList" resultMap="selectExpOneListMap" parameterType="String">
		SELECT 
			a.animal_breed,
			e.exp_reserve_request_date,
			e.exp_start_date,
			e.exp_end_date,
			e.exp_code,
			os.os_name
		FROM 
			t_exp e 
		INNER JOIN 
			t_animal a 
		ON 
			e.animal_code = a.animal_code 
		INNER JOIN
			t_overall_status os
		ON
			e.os_code_exp = os.os_code
		WHERE 
			e.m_exp_id = #{mExpId}
	</select>
	
	<!-- 체험 신청할때 날짜선택 뿌려주는 부분 -->
	<select id="selectExpPeriod" resultType="com.cafe24.iso159.exp.service.ExpPeriod">
		SELECT 
			exp_period_code AS expPeriodCode
			,exp_period_period AS expPeriodPeriod
			,exp_period_level AS exPperiodLevel
			,exp_period_cost AS expPeriodCost
			,exp_period_cost_level AS expPeriodCostLevel
			,exp_period_cost_minus AS expPeriodCostMinus
			,exp_period_journal_count AS expPeriodJournalCount
		FROM 
			t_exp_period;
	</select>
	
	<!-- exp_code PK값 구하는 부분 -->
	<select id="selectExpCode" resultType="int">
		SELECT MAX(CAST(SUBSTRING(exp_code,10) AS DECIMAL)) FROM t_exp
	</select>
	
	<!-- 유기동물 체험신청 부분 -->
	<insert id="addExp" parameterType="com.cafe24.iso159.exp.service.Exp">
		INSERT INTO 
			t_exp
			(exp_code, animal_code, m_exp_id, 
			bl_code, exp_period_code, os_code_exp, 
			os_code_cost_return, exp_journal_count, exp_cost, 
			exp_purpose, exp_reserve_request_date, exp_start_date, 
			exp_end_date) 
		VALUES 
			(#{expCode}, #{animalCode}, #{mExpId}, 
			#{blCode}, #{expPeriodCode}, #{osCodeExp}, 
			#{osCodeCostReturn}, #{expJournalCount}, #{expCost}, 
			#{expPurpose}, now(), #{expStartDate}
			 ,#{expEndDate});
	</insert>
</mapper>